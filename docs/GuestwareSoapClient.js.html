<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: GuestwareSoapClient.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: GuestwareSoapClient.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var unirest = require('unirest');
var DOMParser = require('xmldom').DOMParser;
var GuestwareAPIHelper = require('./GuestwareAPIHelper');

/**
 * Create a new GuestwareSoapClient
 * @param       {String} appName       ApplicationName
 * @param       {String} versionNumber VersionNumber
 * @param       {String} appId         Application wrapper ID
 * @param       {String} username      UserName
 * @param       {String} password      PassWord
 * @constructor
 */
function GuestwareSoapClient(wsdl, appName, versionNumber, appId, username, password) {
  this.wsdl = wsdl;
  this.appName = appName;
  this.versionNumber = versionNumber;
  this.appId = appId;
  this.username = username;
  this.password = password;
  this.requestHeader = generateRequestHeader(
    this.appName,
    this.versionNumber,
    this.appId,
    this.username,
    this.password
  );
  this.requestFooter = generateRequestFooter();
  this.domParser = new DOMParser();
  this.helper = new GuestwareAPIHelper(this);

  function generateRequestHeader(appName, versionNumber, appId, username, password) {
    return [
      '&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:web="http://webservices.guestware.com/">',
        '&lt;soapenv:Header>',
          '&lt;web:' + appId + '>',
            '&lt;web:UserName>' + username + '&lt;/web:UserName>',
            '&lt;web:PassWord>' + password + '&lt;/web:PassWord>',
            '&lt;web:ApplicationName>' + appName + '&lt;/web:ApplicationName>',
            '&lt;web:VersionNumber>' + versionNumber + '&lt;/web:VersionNumber>',
          '&lt;/web:' + appId + '>',
        '&lt;/soapenv:Header>',
        '&lt;soapenv:Body>'
    ];
  }

  function generateRequestFooter() {
    return [
        '&lt;/soapenv:Body>',
      '&lt;/soapenv:Envelope>'
    ];
  }
}

/**
 * Generate a request body for a specific SOAP method
 * @return {Array}
 */
GuestwareSoapClient.prototype.generateMethodBody = function (method, args) {
  var body = [];
  var argKeys = Object.keys(args);
  // Create the method XML object
  body.push('&lt;web:' + method + '>');
  // Create an object for each argument provided, placing the value inside
  argKeys.forEach(function (key) {
    if (args[key]) {
      body.push('&lt;web:' + key + '>');
      body.push(args[key]);
      body.push('&lt;/web:' + key + '>');
    }
  });
  // Close the method XML object
  body.push('&lt;/web:' + method + '>');
  return body;
}

/**
 * Generate a request POST body for a SOAP method
 * @return {Object} -> {raw, string}
 */
GuestwareSoapClient.prototype.generateRequestBody = function (method, args) {
  var request = [];
  Array.prototype.push.apply(request, this.requestHeader);
  Array.prototype.push.apply(request, this.generateMethodBody(method, args));
  Array.prototype.push.apply(request, this.requestFooter);
  return {
    raw: request,
    string: request.join('')
  };
}

/**
 * Make a SOAP request
 * @return {Promise&lt;Object>}
 */
GuestwareSoapClient.prototype.request = function (method, args) {
  var wsdl = this.wsdl;
  var body = this.generateRequestBody(method, args).string;
  var doc = this.domParser;
  return new Promise(function (resolve, reject) {
    unirest
    .post(wsdl)
    .headers({
      'Content-Type': 'text/xml'
    })
    .send(body)
    .end(function (response) {
      if (response.code === 200) {
        resolve({
          raw: response.body,
          parsed: doc.parseFromString(response.body, 'text/xml')
        });
      }
      else reject(response);
    });
  });
}

/**
 * Format the SOAP response into a readable JavaScript object format
 * @param  {DOMParser&lt;Document>} parsedResponse
 * @param  {Object}              dataMap -> {guestwareTagName: newJavaScriptObjectKey}
 * @return {Object}
 */
GuestwareSoapClient.prototype.formatResponse = function(parsedResponse, dataMap, verbose) {
  if (dataMap.$$liTagName) {
    var liTagName = dataMap.$$liTagName;
    delete dataMap.$$liTagName;
    var dataMapKeys = Object.keys(dataMap);
    try {
      var itemList = parsedResponse.getElementsByTagName(liTagName);
    } catch (err) {
      throw new Error('Failed to parse list item');
    }
    var resultList = [];
    for (var i = 0; i &lt; itemList.$$length; i++) {
      var result = {};
      dataMapKeys.forEach(function (key) {
        try {
          result[key] = itemList[i].getElementsByTagName(dataMap[key])[0].firstChild.data;
        } catch (err) {
          if (verbose) console.error('[WARNING] Failed to find key: ' + key);
        }
      });
      resultList.push(result);
    }
    return resultList;
  } else {
    var result = {};
    var dataMapKeys = Object.keys(dataMap);
    dataMapKeys.forEach(function (key) {
      try {
        result[key] = itemList[i].getElementsByTagName(dataMap[key])[0].firstChild.data;
      } catch (err) {
        if (verbose) console.error('[WARNING] Failed to find key: ' + key);
      }
    });
    return result;
  }
}

module.exports = GuestwareSoapClient;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="GuestwareAPIHelper.html">GuestwareAPIHelper</a></li><li><a href="GuestwareSoapClient.html">GuestwareSoapClient</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.3</a> on Fri Jul 21 2017 16:00:47 GMT-0600 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
