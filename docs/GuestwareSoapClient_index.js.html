<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: GuestwareSoapClient/index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: GuestwareSoapClient/index.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var unirest = require('unirest');
var DOMParser = require('xmldom').DOMParser;
var GuestwareAPIHelper = require('../GuestwareAPIHelper');

/**
 * @param {String} appName       ApplicationName
 * @param {String} versionNumber VersionNumber
 * @param {String} username      UserName
 * @param {String} password      PassWord
 * @param {String} appID         SOAP Application Wrapper ID (optional)
 * @constructor
 */
function GuestwareSoapClient(wsdl, appName, versionNumber, username, password, appID) {
  this.wsdl = wsdl;
  this.appName = appName;
  this.versionNumber = versionNumber;
  this.username = username;
  this.password = password;
  this.appID = appID;

  this.requestReadHeader = [
    '&lt;soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:web="http://webservices.guestware.com/">',
      '&lt;soapenv:Header>',
        '&lt;web:' + appID + '>',
          '&lt;web:UserName>' + username + '&lt;/web:UserName>',
          '&lt;web:PassWord>' + password + '&lt;/web:PassWord>',
          '&lt;web:ApplicationName>' + appName + '&lt;/web:ApplicationName>',
          '&lt;web:VersionNumber>' + versionNumber + '&lt;/web:VersionNumber>',
        '&lt;/web:' + appID + '>',
      '&lt;/soapenv:Header>',
      '&lt;soapenv:Body>'
  ];
  this.requestReadFooter = [
      '&lt;/soapenv:Body>',
    '&lt;/soapenv:Envelope>'
  ];
  this.requestUpdateHeader = [
    '&lt;?xml version="1.0" encoding="UTF-8"?>',
    '&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">',
      '&lt;soap:Header>',
        appID ? '&lt;' + appID + ' xmlns="http://webservices.guestware.com/">' : '',
          '&lt;UserName>' + username + '&lt;/UserName>',
          '&lt;PassWord>' + password + '&lt;/PassWord>',
        appID ? '&lt;/' + appID + '>' : '',
      '&lt;/soap:Header>',
      '&lt;soap:Body>'
  ];
  this.requestUpdateFooter = [
      '&lt;/soap:Body>',
    '&lt;/soap:Envelope>'
  ];

  this.domParser = new DOMParser();
  this.helper = new GuestwareAPIHelper(this);
}

/**
 * @param  {String} elementId     type of SOAP element (eg. GUEST_VISIT)
 * @param  {Object} elementValues values of the SOAP element (eg. GuestID)
 * @return {Object} {newObject&lt;Array>, oldObject&lt;Array>}
 */
GuestwareSoapClient.prototype.generateElement = function (elementId, elementValues) {
  function generateElementValue (keyName, keyValue) {
    if (typeof keyValue !== 'undefined') {
      return (
        '&lt;' + keyName + '>'
          + keyValue +
        '&lt;/' + keyName + '>'
      );
    }
  }

  var result = {
    newObject: [],
    oldObject: []
  }
  var elementType = elementValues.$$elementType;
  var elementUpdateType = elementValues.$$elementUpdateType;

  if (typeof elementType === 'undefined'
   || typeof elementUpdateType === 'undefined')
    return result;

  result.newObject.push('&lt;' + elementType + ' diffgr:id="' + elementType + elementId + '" msdata:rowOrder="' + (elementId - 1) + '" diffgr:hasChanges="' + elementUpdateType  + '">');
  if (elementUpdateType === 'modified') {
    result.oldObject.push('&lt;' + elementType + ' diffgr:id="' + elementType + elementId + '" msdata:rowOrder="' + (elementId - 1) + '">');
  }

  Object.keys(elementValues).forEach(function (valueKey) {
    if (valueKey !== '$$elementType' &amp;&amp; valueKey !== '$$elementUpdateType') {
      result.newObject.push(generateElementValue(valueKey, elementValues[valueKey]));
      if (elementUpdateType === 'modified') {
        result.oldObject.push(generateElementValue(valueKey, elementValues[valueKey]));
      }
    }
  });

  result.newObject.push('&lt;/' + elementType + '>');
  if (elementUpdateType === 'modified') {
    result.oldObject.push('&lt;/' + elementType + '>');
  }

  return result;
}

/**
 * Generate a read request body for a specific SOAP Read method
 * @return {Array}
 */
GuestwareSoapClient.prototype.generateReadBody = function (method, args, body) {
  var body = body || [];
  var argKeys = Object.keys(args);
  // Create the method XML object
  if (typeof method !== 'undefined') body.push('&lt;web:' + method + '>');
  // Create an object for each argument provided, placing the value inside
  argKeys.forEach(function (key) {
    if (typeof args[key] !== 'undefined') {
      body.push('&lt;web:' + key + '>');
      body.push(args[key]);
      body.push('&lt;/web:' + key + '>');
    }
  }.bind(this));
  // Close the method XML object
  if (typeof method !== 'undefined') body.push('&lt;/web:' + method + '>');
  return body;
}

/**
 * Generate a request POST body for a SOAP update method
 * @return {Object} {raw, string}
 */
GuestwareSoapClient.prototype.generateUpdateRequestBody = function (method, objectName, changeList) {
  var request = [];
  var requestBodyHeader = [
    '&lt;' + method + ' xmlns="http://webservices.guestware.com/">',
      '&lt;' + objectName + ' xmlns:msdata="urn:schemas-microsoft-com:xml-msdata" msdata:SchemaSerializationMode="ExcludeSchema">',
        '&lt;xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns="http://webservices.guestware.com/dstGST.xsd" xmlns:msprop="urn:schemas-microsoft-com:xml-msprop" xmlns:mstns="http://webservices.guestware.com/dstGST.xsd" id="dstGST" targetNamespace="http://webservices.guestware.com/dstGST.xsd" attributeFormDefault="qualified" elementFormDefault="qualified">',
          '&lt;xs:element name="dstGST" msdata:IsDataSet="true" msdata:UseCurrentLocale="true">',
            '&lt;xs:complexType>',
              '&lt;xs:choice minOccurs="0" maxOccurs="unbounded"/>',
            '&lt;/xs:complexType>',
          '&lt;/xs:element>',
        '&lt;/xs:schema>',
        '&lt;diffgr:diffgram xmlns:diffgr="urn:schemas-microsoft-com:xml-diffgram-v1">'
  ];
  var requestBodyFooter = [
        '&lt;/diffgr:diffgram>',
      '&lt;/' + objectName + '>',
    '&lt;/' + method + '>'
  ];

  var oldList = [];
  var newList = [];
  var typeCounters = {};
  changeList.forEach(function (change, i) {
    if (typeof typeCounters[change.$$elementType] === 'undefined')
      typeCounters[change.$$elementType] = 1;
    else typeCounters[change.$$elementType]++;

    var elementBody = this.generateElement(typeCounters[change.$$elementType], change);
    Array.prototype.push.apply(newList, elementBody.newObject);
    if (elementBody.oldObject.length > 0) {
      Array.prototype.push.apply(oldList, elementBody.oldObject);
    }
  }.bind(this));

  Array.prototype.push.apply(request, this.requestUpdateHeader);
  Array.prototype.push.apply(request, requestBodyHeader);
  request.push('&lt;dstGST xmlns="http://webservices.guestware.com/dstGST.xsd">');
  Array.prototype.push.apply(request, newList);
  request.push('&lt;/dstGST>');
  request.push('&lt;diffgr:before>');
  Array.prototype.push.apply(request, oldList);
  request.push('&lt;/diffgr:before>');
  Array.prototype.push.apply(request, requestBodyFooter);
  Array.prototype.push.apply(request, this.requestUpdateFooter);

  return {
    raw: request,
    string: request.join('')
  };
}

/**
 * Generate a request POST body for a SOAP read method
 * @return {Object} {raw, string}
 */
GuestwareSoapClient.prototype.generateReadRequestBody = function (method, args) {
  var request = [];
  Array.prototype.push.apply(request, this.requestReadHeader);
  Array.prototype.push.apply(request, this.generateReadBody(method, args));
  Array.prototype.push.apply(request, this.requestReadFooter);
  return {
    raw: request,
    string: request.join('')
  };
}

GuestwareSoapClient.prototype.generateRequest = function (body) {
  var wsdl = this.wsdl;
  var doc = this.domParser;
  return new Promise(function (resolve, reject) {
    unirest
    .post(wsdl)
    .headers({
      'Content-Type': 'text/xml'
    })
    .send(body)
    .end(function (response) {
      if (response.code === 200) {
        resolve({
          raw: response.body,
          parsed: doc.parseFromString(response.body, 'text/xml')
        });
      }
      else reject(response);
    });
  });
}

/**
 * Make a SOAP update request
 * @return {Promise&lt;Object>}
 */
GuestwareSoapClient.prototype.update = function (method, objectName, changeList) {
  return this.generateRequest(this.generateUpdateRequestBody(method, objectName, changeList).string);
}

/**
 * Make a SOAP read request
 * @return {Promise&lt;Object>}
 */
GuestwareSoapClient.prototype.read = function (method, args) {
  return this.generateRequest(this.generateReadRequestBody(method, args).string);
}

/**
 * Format the SOAP response into a readable JavaScript object format
 * @param  {DOMParser&lt;Document>} parsedResponse
 * @param  {Object}              dataMap -> {guestwareTagName: newJavaScriptObjectKey}
 * @return {Object}
 */
GuestwareSoapClient.prototype.formatResponse = function(parsedResponse, dataMap, verbose) {
  if (dataMap.$$liTagName) {
    var liTagName = dataMap.$$liTagName;
    delete dataMap.$$liTagName;
    var dataMapKeys = Object.keys(dataMap);
    try {
      var itemList = parsedResponse.getElementsByTagName(liTagName);
    } catch (err) {
      throw err;
    }
    var resultList = [];
    for (var i = 0; i &lt; itemList.$$length; i++) {
      var result = {};
      dataMapKeys.forEach(function (key) {
        try {
          result[key] = itemList[i].getElementsByTagName(dataMap[key])[0].firstChild.data;
        } catch (err) {
          if (verbose) console.error('[WARNING] Failed to find key: ' + key);
        }
      });
      resultList.push(result);
    }
    return resultList;
  } else {
    var result = {};
    var dataMapKeys = Object.keys(dataMap);
    dataMapKeys.forEach(function (key) {
      try {
        result[key] = itemList[i].getElementsByTagName(dataMap[key])[0].firstChild.data;
      } catch (err) {
        if (verbose) console.error('[WARNING] Failed to find key: ' + key);
      }
    });
    return result;
  }
}

/**
 * @return {Object} {raw, parsed}
 */
GuestwareSoapClient.prototype.generateMockResponse = function (methodName, data) {
  var output = [];
  var responseHeader = [
    '&lt;?xml version="1.0" encoding="utf-8"?>',
    '&lt;soap:Envelope xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema">',
      '&lt;soap:Body>',
        '&lt;'+methodName+'Response xmlns="http://webservices.guestware.com/">',
          '&lt;'+methodName+'Result msdata:SchemaSerializationMode="ExcludeSchema" xmlns:msdata="urn:schemas-microsoft-com:xml-msdata">',
            '&lt;xs:schema id="dstGST" targetNamespace="http://webservices.guestware.com/dstGST.xsd" xmlns:mstns="http://webservices.guestware.com/dstGST.xsd" xmlns="http://webservices.guestware.com/dstGST.xsd" xmlns:xs="http://www.w3.org/2001/XMLSchema" xmlns:msdata="urn:schemas-microsoft-com:xml-msdata" xmlns:msprop="urn:schemas-microsoft-com:xml-msprop" attributeFormDefault="qualified" elementFormDefault="qualified">',
              '&lt;xs:element name="dstGST" msdata:IsDataSet="true" msdata:UseCurrentLocale="true">',
                '&lt;xs:complexType>',
                  '&lt;xs:choice minOccurs="0" maxOccurs="unbounded" />',
                '&lt;/xs:complexType>',
              '&lt;/xs:element>',
            '&lt;/xs:schema>',
            '&lt;diffgr:diffgram xmlns:msdata="urn:schemas-microsoft-com:xml-msdata" xmlns:diffgr="urn:schemas-microsoft-com:xml-diffgram-v1">',
              '&lt;dstGST xmlns="http://webservices.guestware.com/dstGST.xsd">',
  ];
  var responseFooter = [
              '&lt;/dstGST>',
            '&lt;/diffgr:diffgram>',
          '&lt;/'+methodName+'Result>',
        '&lt;/'+methodName+'Response>',
      '&lt;/soap:Body>',
    '&lt;/soap:Envelope>'
  ];
  var dataCopy = Object.assign({}, data);
  var dataCopyArr = Object.keys(dataCopy).map(function (key) {
    return dataCopy[key];
  });

  var responseBody = [];
  var typeCounters = {};
  dataCopyArr.forEach(function (dataObject, i) {
    if (typeof typeCounters[dataObject.$$elementType] === 'undefined')
      typeCounters[dataObject.$$elementType] = 1;
    else typeCounters[dataObject.$$elementType]++;
    var elementBody = this.generateElement(typeCounters[dataObject.$$elementType], dataObject);
    Array.prototype.push.apply(responseBody, elementBody.oldObject);
  }.bind(this));

  Array.prototype.push.apply(output, responseHeader);
  Array.prototype.push.apply(output, responseBody);
  Array.prototype.push.apply(output, responseFooter);

  return ({
    raw: output.join(''),
    parsed: this.domParser.parseFromString(output.join(''), 'text/xml')
  });
}

module.exports = GuestwareSoapClient;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="GuestwareAPIHelper.html">GuestwareAPIHelper</a></li><li><a href="GuestwareSoapClient.html">GuestwareSoapClient</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.3</a> on Mon Jul 24 2017 23:33:42 GMT-0600 (CST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
